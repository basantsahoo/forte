import sys
from pathlib import Path
project_path = str(Path(__file__).resolve().parent.parent)
sys.path.insert(1, project_path)
import pandas as pd
from datetime import datetime
import time
import json
import traceback
import math

from backtest.settings import reports_dir
from backtest.bt_strategies import *
from dynamics.profile.market_profile import HistMarketProfileService
from arc.algo_portfolio import AlgoPortfolioManager
from arc.data_interface_for_backtest import AlgorithmBacktestIterface
from arc.insight import InsightBook
from db.market_data import (get_all_days, get_daily_tick_data, get_daily_option_data_2)
import helper.utils as helper_utils

default_symbols =  ['NIFTY', 'BANKNIFTY']


class StartegyBackTester:
    def __init__(self, strat_config):
        self.strat_config = strat_config

    def configure(self):
        if len(self.strat_config.symbols) == 0:
            self.strat_config.symbols = default_symbols

    def back_test(self, symbol):
        results = []
        start_time = datetime.now()
        for day in self.strat_config['test_days']:
            print(day)
            print('=========================================================================================')

            processor = HistMarketProfileService()

            in_day = day if type(day) == str else day.strftime('%Y-%m-%d')
            start = datetime.now()

            story_book = InsightBook(symbol, in_day, record_metric=self.strat_config['record_metric'], candle_sw=self.strat_config['candle_sw'])
            end = datetime.now()
            print('insight book init took', (end-start).total_seconds())
            place_live = False
            interface = None
            if self.strat_config.get("send_to_oms", False):
                interface = AlgorithmBacktestIterface()
                place_live = True
            pm = AlgoPortfolioManager(place_live, interface)
            story_book.pm = pm

            #story_book.profile_processor = processor
            for s_id in range(len(self.strat_config['strategies'])):
                start = datetime.now()
                print('strategy=====', self.strat_config['strategies'][s_id])
                strategy_class = eval(self.strat_config['strategies'][s_id])
                strategy_kwargs = self.strat_config['strategy_kwargs'][s_id]
                story_book.add_strategy(strategy_class, strategy_kwargs)
                end = datetime.now()
                print('strategy init took', (end - start).total_seconds())
            start = datetime.now()
            price_list = get_daily_tick_data(symbol, day)
            price_list['symbol'] = helper_utils.root_symbol(symbol)
            price_list = price_list.to_dict('records')
            end = datetime.now()
            print('price list fetch took', (end - start).total_seconds())
            #print(price_list)
            #price_list = [{'timestamp': 1655783160, 'open': 15455.95, 'high': 15473.15, 'low': 15441.4, 'close': 15467.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783220, 'open': 15467.15, 'high': 15480.3, 'low': 15452.45, 'close': 15455.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783280, 'open': 15454.45, 'high': 15469.5, 'low': 15449.6, 'close': 15456.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783340, 'open': 15457.85, 'high': 15482.85, 'low': 15457.85, 'close': 15474.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783400, 'open': 15471.65, 'high': 15480.35, 'low': 15458.15, 'close': 15480.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783460, 'open': 15480.85, 'high': 15489.5, 'low': 15471.15, 'close': 15480.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783520, 'open': 15480.0, 'high': 15482.9, 'low': 15470.7, 'close': 15470.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783580, 'open': 15470.4, 'high': 15473.45, 'low': 15456.5, 'close': 15457.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783640, 'open': 15455.7, 'high': 15467.2, 'low': 15454.2, 'close': 15466.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783700, 'open': 15467.25, 'high': 15470.6, 'low': 15457.65, 'close': 15457.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783760, 'open': 15456.55, 'high': 15470.6, 'low': 15454.6, 'close': 15467.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783820, 'open': 15466.15, 'high': 15466.15, 'low': 15449.35, 'close': 15451.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783880, 'open': 15450.3, 'high': 15450.3, 'low': 15437.8, 'close': 15438.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655783940, 'open': 15438.05, 'high': 15444.3, 'low': 15434.0, 'close': 15439.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784000, 'open': 15439.65, 'high': 15444.2, 'low': 15428.45, 'close': 15438.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784060, 'open': 15439.1, 'high': 15441.9, 'low': 15424.05, 'close': 15426.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784120, 'open': 15425.95, 'high': 15430.85, 'low': 15419.85, 'close': 15429.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784180, 'open': 15430.85, 'high': 15438.8, 'low': 15427.5, 'close': 15438.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784240, 'open': 15438.5, 'high': 15463.75, 'low': 15437.2, 'close': 15460.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784300, 'open': 15460.95, 'high': 15460.95, 'low': 15453.25, 'close': 15460.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784360, 'open': 15459.65, 'high': 15470.7, 'low': 15454.65, 'close': 15468.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784420, 'open': 15469.3, 'high': 15474.35, 'low': 15466.05, 'close': 15466.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784480, 'open': 15465.35, 'high': 15466.55, 'low': 15450.9, 'close': 15461.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784540, 'open': 15461.8, 'high': 15472.0, 'low': 15461.15, 'close': 15468.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784600, 'open': 15466.35, 'high': 15469.65, 'low': 15461.15, 'close': 15461.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784660, 'open': 15461.35, 'high': 15464.55, 'low': 15457.5, 'close': 15461.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784720, 'open': 15461.7, 'high': 15466.65, 'low': 15455.95, 'close': 15464.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784780, 'open': 15465.95, 'high': 15470.5, 'low': 15462.0, 'close': 15467.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784840, 'open': 15466.3, 'high': 15470.4, 'low': 15461.05, 'close': 15468.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784900, 'open': 15466.3, 'high': 15478.05, 'low': 15466.3, 'close': 15473.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655784960, 'open': 15472.6, 'high': 15480.5, 'low': 15472.6, 'close': 15480.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785020, 'open': 15481.55, 'high': 15491.25, 'low': 15481.55, 'close': 15491.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785080, 'open': 15492.05, 'high': 15504.65, 'low': 15492.05, 'close': 15502.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785140, 'open': 15501.85, 'high': 15512.3, 'low': 15501.85, 'close': 15511.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785200, 'open': 15512.0, 'high': 15518.9, 'low': 15512.0, 'close': 15515.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785260, 'open': 15516.7, 'high': 15519.65, 'low': 15506.15, 'close': 15514.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785320, 'open': 15513.9, 'high': 15534.95, 'low': 15513.9, 'close': 15529.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785380, 'open': 15528.2, 'high': 15532.25, 'low': 15521.75, 'close': 15528.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785440, 'open': 15528.8, 'high': 15531.95, 'low': 15519.45, 'close': 15530.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785500, 'open': 15531.4, 'high': 15536.1, 'low': 15524.8, 'close': 15526.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785560, 'open': 15525.8, 'high': 15531.5, 'low': 15525.25, 'close': 15528.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785620, 'open': 15528.6, 'high': 15543.9, 'low': 15528.45, 'close': 15542.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785680, 'open': 15541.6, 'high': 15549.4, 'low': 15541.25, 'close': 15544.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785740, 'open': 15545.7, 'high': 15546.9, 'low': 15539.7, 'close': 15541.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785800, 'open': 15541.25, 'high': 15544.85, 'low': 15539.9, 'close': 15541.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785860, 'open': 15542.75, 'high': 15551.65, 'low': 15542.75, 'close': 15550.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785920, 'open': 15550.2, 'high': 15551.7, 'low': 15543.9, 'close': 15547.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655785980, 'open': 15547.75, 'high': 15559.2, 'low': 15547.15, 'close': 15557.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786040, 'open': 15558.7, 'high': 15562.75, 'low': 15555.6, 'close': 15558.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786100, 'open': 15558.85, 'high': 15561.5, 'low': 15557.25, 'close': 15561.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786160, 'open': 15561.15, 'high': 15561.8, 'low': 15549.4, 'close': 15550.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786220, 'open': 15549.55, 'high': 15551.8, 'low': 15543.85, 'close': 15545.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786280, 'open': 15544.6, 'high': 15546.95, 'low': 15539.75, 'close': 15546.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786340, 'open': 15547.35, 'high': 15560.4, 'low': 15547.35, 'close': 15560.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786400, 'open': 15560.65, 'high': 15569.85, 'low': 15560.65, 'close': 15563.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786460, 'open': 15562.65, 'high': 15562.65, 'low': 15548.2, 'close': 15550.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786520, 'open': 15550.9, 'high': 15557.75, 'low': 15549.25, 'close': 15554.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786580, 'open': 15554.55, 'high': 15561.45, 'low': 15553.85, 'close': 15557.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786640, 'open': 15557.75, 'high': 15560.45, 'low': 15555.3, 'close': 15560.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786700, 'open': 15560.25, 'high': 15560.65, 'low': 15553.5, 'close': 15556.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786760, 'open': 15556.3, 'high': 15560.2, 'low': 15551.8, 'close': 15553.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786820, 'open': 15554.4, 'high': 15554.55, 'low': 15543.9, 'close': 15545.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786880, 'open': 15544.8, 'high': 15553.75, 'low': 15544.8, 'close': 15551.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655786940, 'open': 15551.4, 'high': 15553.4, 'low': 15546.85, 'close': 15548.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787000, 'open': 15548.05, 'high': 15552.05, 'low': 15544.95, 'close': 15550.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787060, 'open': 15550.1, 'high': 15553.8, 'low': 15546.55, 'close': 15550.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787120, 'open': 15550.45, 'high': 15558.85, 'low': 15548.6, 'close': 15558.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787180, 'open': 15559.8, 'high': 15578.8, 'low': 15559.8, 'close': 15578.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787240, 'open': 15578.1, 'high': 15582.95, 'low': 15573.45, 'close': 15581.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787300, 'open': 15580.95, 'high': 15586.55, 'low': 15579.65, 'close': 15580.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787360, 'open': 15581.25, 'high': 15583.75, 'low': 15574.0, 'close': 15576.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787420, 'open': 15576.5, 'high': 15577.15, 'low': 15569.9, 'close': 15571.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787480, 'open': 15571.9, 'high': 15578.65, 'low': 15571.9, 'close': 15577.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787540, 'open': 15577.4, 'high': 15581.25, 'low': 15575.05, 'close': 15576.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787600, 'open': 15575.95, 'high': 15579.7, 'low': 15575.65, 'close': 15575.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787660, 'open': 15575.9, 'high': 15580.0, 'low': 15575.2, 'close': 15576.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787720, 'open': 15576.9, 'high': 15587.4, 'low': 15576.9, 'close': 15584.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787780, 'open': 15584.3, 'high': 15590.2, 'low': 15584.3, 'close': 15588.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787840, 'open': 15588.35, 'high': 15593.3, 'low': 15586.7, 'close': 15587.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787900, 'open': 15587.55, 'high': 15589.75, 'low': 15583.3, 'close': 15586.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655787960, 'open': 15585.2, 'high': 15587.2, 'low': 15581.7, 'close': 15587.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788020, 'open': 15586.6, 'high': 15586.6, 'low': 15574.85, 'close': 15574.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788080, 'open': 15575.25, 'high': 15579.5, 'low': 15572.35, 'close': 15578.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788140, 'open': 15578.6, 'high': 15578.6, 'low': 15570.45, 'close': 15574.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788200, 'open': 15574.65, 'high': 15585.45, 'low': 15574.65, 'close': 15584.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788260, 'open': 15584.55, 'high': 15590.9, 'low': 15582.25, 'close': 15589.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788320, 'open': 15589.85, 'high': 15590.05, 'low': 15582.3, 'close': 15585.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788380, 'open': 15585.35, 'high': 15587.35, 'low': 15583.45, 'close': 15583.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788440, 'open': 15583.45, 'high': 15584.3, 'low': 15581.05, 'close': 15581.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788500, 'open': 15581.6, 'high': 15584.1, 'low': 15575.8, 'close': 15575.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788560, 'open': 15576.55, 'high': 15577.45, 'low': 15567.0, 'close': 15567.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788620, 'open': 15567.5, 'high': 15570.25, 'low': 15564.65, 'close': 15564.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788680, 'open': 15564.3, 'high': 15577.1, 'low': 15563.5, 'close': 15576.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788740, 'open': 15576.55, 'high': 15576.55, 'low': 15568.9, 'close': 15571.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788800, 'open': 15571.35, 'high': 15573.4, 'low': 15565.2, 'close': 15569.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788860, 'open': 15568.75, 'high': 15571.1, 'low': 15565.4, 'close': 15566.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788920, 'open': 15565.55, 'high': 15574.15, 'low': 15565.35, 'close': 15571.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655788980, 'open': 15570.85, 'high': 15571.4, 'low': 15563.85, 'close': 15569.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789040, 'open': 15569.55, 'high': 15578.35, 'low': 15569.55, 'close': 15576.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789100, 'open': 15577.05, 'high': 15588.85, 'low': 15576.6, 'close': 15584.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789160, 'open': 15584.3, 'high': 15585.4, 'low': 15576.05, 'close': 15578.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789220, 'open': 15578.55, 'high': 15580.3, 'low': 15573.65, 'close': 15577.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789280, 'open': 15577.45, 'high': 15582.05, 'low': 15577.0, 'close': 15581.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789340, 'open': 15583.2, 'high': 15583.2, 'low': 15576.65, 'close': 15577.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789400, 'open': 15578.25, 'high': 15581.75, 'low': 15574.8, 'close': 15574.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789460, 'open': 15574.8, 'high': 15579.45, 'low': 15574.8, 'close': 15579.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789520, 'open': 15578.5, 'high': 15579.65, 'low': 15572.9, 'close': 15572.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789580, 'open': 15572.45, 'high': 15576.65, 'low': 15572.2, 'close': 15575.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789640, 'open': 15576.45, 'high': 15577.55, 'low': 15574.7, 'close': 15576.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789700, 'open': 15576.7, 'high': 15577.05, 'low': 15574.6, 'close': 15574.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789760, 'open': 15575.0, 'high': 15579.0, 'low': 15569.55, 'close': 15578.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789820, 'open': 15578.0, 'high': 15579.5, 'low': 15573.5, 'close': 15577.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789880, 'open': 15578.45, 'high': 15580.3, 'low': 15576.6, 'close': 15577.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655789940, 'open': 15578.7, 'high': 15579.45, 'low': 15575.35, 'close': 15575.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790000, 'open': 15576.0, 'high': 15578.65, 'low': 15574.8, 'close': 15575.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790060, 'open': 15575.9, 'high': 15575.9, 'low': 15567.35, 'close': 15574.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790120, 'open': 15574.55, 'high': 15575.35, 'low': 15572.3, 'close': 15573.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790180, 'open': 15573.4, 'high': 15582.9, 'low': 15573.4, 'close': 15582.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790240, 'open': 15582.55, 'high': 15585.15, 'low': 15582.0, 'close': 15583.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790300, 'open': 15583.7, 'high': 15593.6, 'low': 15582.9, 'close': 15592.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790360, 'open': 15591.95, 'high': 15592.45, 'low': 15583.7, 'close': 15584.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790420, 'open': 15583.55, 'high': 15586.3, 'low': 15580.05, 'close': 15582.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790480, 'open': 15581.9, 'high': 15582.1, 'low': 15576.1, 'close': 15576.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790540, 'open': 15576.55, 'high': 15579.4, 'low': 15575.35, 'close': 15579.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790600, 'open': 15579.1, 'high': 15579.1, 'low': 15570.15, 'close': 15570.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790660, 'open': 15568.75, 'high': 15571.3, 'low': 15563.0, 'close': 15564.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790720, 'open': 15564.45, 'high': 15570.5, 'low': 15564.45, 'close': 15568.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790780, 'open': 15569.6, 'high': 15571.0, 'low': 15565.55, 'close': 15566.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790840, 'open': 15567.25, 'high': 15568.95, 'low': 15564.45, 'close': 15566.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790900, 'open': 15566.55, 'high': 15571.5, 'low': 15565.7, 'close': 15571.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655790960, 'open': 15570.85, 'high': 15578.8, 'low': 15570.4, 'close': 15576.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791020, 'open': 15575.85, 'high': 15576.0, 'low': 15567.7, 'close': 15567.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791080, 'open': 15567.95, 'high': 15574.9, 'low': 15567.15, 'close': 15571.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791140, 'open': 15572.35, 'high': 15572.75, 'low': 15570.6, 'close': 15572.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791200, 'open': 15573.4, 'high': 15575.15, 'low': 15571.5, 'close': 15574.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791260, 'open': 15575.0, 'high': 15579.35, 'low': 15573.9, 'close': 15577.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791320, 'open': 15577.6, 'high': 15578.0, 'low': 15575.0, 'close': 15577.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791380, 'open': 15577.25, 'high': 15579.55, 'low': 15576.15, 'close': 15578.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791440, 'open': 15578.65, 'high': 15586.75, 'low': 15578.1, 'close': 15585.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791500, 'open': 15585.3, 'high': 15589.8, 'low': 15584.5, 'close': 15589.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791560, 'open': 15588.5, 'high': 15588.7, 'low': 15583.1, 'close': 15583.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791620, 'open': 15584.05, 'high': 15584.5, 'low': 15581.05, 'close': 15582.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791680, 'open': 15582.1, 'high': 15599.4, 'low': 15581.65, 'close': 15598.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791740, 'open': 15598.35, 'high': 15607.2, 'low': 15598.35, 'close': 15606.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791800, 'open': 15606.55, 'high': 15610.8, 'low': 15606.55, 'close': 15609.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791860, 'open': 15609.45, 'high': 15610.5, 'low': 15602.25, 'close': 15602.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791920, 'open': 15602.6, 'high': 15613.55, 'low': 15597.7, 'close': 15612.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655791980, 'open': 15612.0, 'high': 15615.3, 'low': 15609.65, 'close': 15612.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792040, 'open': 15612.35, 'high': 15612.45, 'low': 15605.45, 'close': 15607.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792100, 'open': 15606.7, 'high': 15607.55, 'low': 15603.85, 'close': 15603.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792160, 'open': 15603.4, 'high': 15608.95, 'low': 15602.9, 'close': 15608.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792220, 'open': 15609.55, 'high': 15611.85, 'low': 15607.4, 'close': 15608.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792280, 'open': 15607.7, 'high': 15611.85, 'low': 15607.7, 'close': 15610.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792340, 'open': 15609.85, 'high': 15613.8, 'low': 15609.75, 'close': 15612.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792400, 'open': 15613.3, 'high': 15613.5, 'low': 15608.1, 'close': 15608.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792460, 'open': 15609.0, 'high': 15609.0, 'low': 15603.35, 'close': 15605.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792520, 'open': 15603.4, 'high': 15604.55, 'low': 15600.05, 'close': 15601.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792580, 'open': 15601.7, 'high': 15607.0, 'low': 15601.45, 'close': 15606.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792640, 'open': 15606.65, 'high': 15610.2, 'low': 15606.2, 'close': 15610.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792700, 'open': 15609.75, 'high': 15610.8, 'low': 15604.8, 'close': 15606.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792760, 'open': 15606.05, 'high': 15610.3, 'low': 15605.25, 'close': 15605.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792820, 'open': 15605.5, 'high': 15605.55, 'low': 15597.1, 'close': 15597.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792880, 'open': 15598.55, 'high': 15605.75, 'low': 15597.15, 'close': 15605.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655792940, 'open': 15606.25, 'high': 15609.15, 'low': 15602.05, 'close': 15606.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793000, 'open': 15606.1, 'high': 15608.15, 'low': 15604.45, 'close': 15605.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793060, 'open': 15604.9, 'high': 15610.25, 'low': 15604.9, 'close': 15609.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793120, 'open': 15609.9, 'high': 15615.6, 'low': 15606.9, 'close': 15613.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793180, 'open': 15612.65, 'high': 15612.65, 'low': 15608.3, 'close': 15609.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793240, 'open': 15608.9, 'high': 15611.65, 'low': 15606.6, 'close': 15607.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793300, 'open': 15608.2, 'high': 15613.6, 'low': 15608.2, 'close': 15611.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793360, 'open': 15611.65, 'high': 15612.95, 'low': 15610.25, 'close': 15611.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793420, 'open': 15611.5, 'high': 15617.65, 'low': 15610.9, 'close': 15612.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793480, 'open': 15612.15, 'high': 15612.4, 'low': 15605.9, 'close': 15606.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793540, 'open': 15606.35, 'high': 15608.3, 'low': 15600.4, 'close': 15600.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793600, 'open': 15600.35, 'high': 15602.4, 'low': 15594.25, 'close': 15596.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793660, 'open': 15596.35, 'high': 15596.35, 'low': 15586.65, 'close': 15589.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793720, 'open': 15587.6, 'high': 15590.65, 'low': 15587.15, 'close': 15588.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793780, 'open': 15588.25, 'high': 15594.25, 'low': 15587.4, 'close': 15592.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793840, 'open': 15593.5, 'high': 15595.0, 'low': 15587.55, 'close': 15588.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793900, 'open': 15588.65, 'high': 15588.65, 'low': 15581.1, 'close': 15584.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655793960, 'open': 15584.9, 'high': 15591.45, 'low': 15583.5, 'close': 15589.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794020, 'open': 15588.05, 'high': 15591.35, 'low': 15586.35, 'close': 15591.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794080, 'open': 15591.5, 'high': 15594.7, 'low': 15591.5, 'close': 15593.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794140, 'open': 15594.15, 'high': 15598.2, 'low': 15593.8, 'close': 15596.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794200, 'open': 15596.7, 'high': 15602.65, 'low': 15595.75, 'close': 15602.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794260, 'open': 15603.1, 'high': 15606.05, 'low': 15601.5, 'close': 15601.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794320, 'open': 15601.3, 'high': 15601.45, 'low': 15598.35, 'close': 15601.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794380, 'open': 15600.7, 'high': 15603.7, 'low': 15599.45, 'close': 15600.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794440, 'open': 15599.7, 'high': 15605.75, 'low': 15599.6, 'close': 15605.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794500, 'open': 15605.9, 'high': 15610.75, 'low': 15605.45, 'close': 15609.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794560, 'open': 15609.25, 'high': 15609.35, 'low': 15603.1, 'close': 15606.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794620, 'open': 15606.7, 'high': 15608.75, 'low': 15605.85, 'close': 15606.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794680, 'open': 15605.75, 'high': 15610.7, 'low': 15604.9, 'close': 15610.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794740, 'open': 15610.65, 'high': 15616.55, 'low': 15609.9, 'close': 15615.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794800, 'open': 15615.35, 'high': 15615.75, 'low': 15611.35, 'close': 15615.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794860, 'open': 15615.2, 'high': 15618.7, 'low': 15612.2, 'close': 15615.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794920, 'open': 15615.2, 'high': 15617.65, 'low': 15612.45, 'close': 15615.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655794980, 'open': 15615.45, 'high': 15616.35, 'low': 15611.4, 'close': 15615.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795040, 'open': 15616.0, 'high': 15623.8, 'low': 15616.0, 'close': 15622.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795100, 'open': 15622.2, 'high': 15622.65, 'low': 15617.4, 'close': 15620.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795160, 'open': 15619.9, 'high': 15622.05, 'low': 15616.05, 'close': 15616.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795220, 'open': 15615.55, 'high': 15618.15, 'low': 15613.9, 'close': 15618.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795280, 'open': 15617.9, 'high': 15620.45, 'low': 15616.65, 'close': 15619.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795340, 'open': 15620.0, 'high': 15621.25, 'low': 15617.5, 'close': 15617.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795400, 'open': 15617.25, 'high': 15618.5, 'low': 15612.3, 'close': 15612.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795460, 'open': 15613.15, 'high': 15613.15, 'low': 15605.45, 'close': 15610.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795520, 'open': 15610.75, 'high': 15616.6, 'low': 15608.1, 'close': 15615.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795580, 'open': 15614.8, 'high': 15617.65, 'low': 15614.3, 'close': 15617.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795640, 'open': 15616.7, 'high': 15619.95, 'low': 15616.05, 'close': 15619.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795700, 'open': 15619.75, 'high': 15623.4, 'low': 15617.1, 'close': 15622.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795760, 'open': 15622.7, 'high': 15640.1, 'low': 15622.7, 'close': 15638.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795820, 'open': 15638.85, 'high': 15644.45, 'low': 15638.35, 'close': 15643.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795880, 'open': 15643.65, 'high': 15645.7, 'low': 15640.05, 'close': 15642.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655795940, 'open': 15641.35, 'high': 15643.55, 'low': 15639.25, 'close': 15642.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796000, 'open': 15642.7, 'high': 15648.8, 'low': 15641.8, 'close': 15648.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796060, 'open': 15648.7, 'high': 15649.3, 'low': 15637.4, 'close': 15637.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796120, 'open': 15638.75, 'high': 15643.75, 'low': 15638.75, 'close': 15642.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796180, 'open': 15642.05, 'high': 15647.65, 'low': 15640.45, 'close': 15646.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796240, 'open': 15645.35, 'high': 15649.45, 'low': 15642.65, 'close': 15642.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796300, 'open': 15643.45, 'high': 15645.6, 'low': 15641.8, 'close': 15644.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796360, 'open': 15643.9, 'high': 15647.7, 'low': 15642.45, 'close': 15642.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796420, 'open': 15641.35, 'high': 15641.7, 'low': 15633.15, 'close': 15633.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796480, 'open': 15633.45, 'high': 15639.15, 'low': 15633.45, 'close': 15638.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796540, 'open': 15637.4, 'high': 15642.3, 'low': 15634.85, 'close': 15642.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796600, 'open': 15642.75, 'high': 15645.7, 'low': 15639.2, 'close': 15640.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796660, 'open': 15640.75, 'high': 15644.6, 'low': 15640.75, 'close': 15643.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796720, 'open': 15643.8, 'high': 15654.0, 'low': 15643.15, 'close': 15652.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796780, 'open': 15652.5, 'high': 15658.9, 'low': 15649.3, 'close': 15656.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796840, 'open': 15655.75, 'high': 15657.85, 'low': 15653.55, 'close': 15653.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796900, 'open': 15653.55, 'high': 15656.25, 'low': 15652.0, 'close': 15656.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655796960, 'open': 15655.95, 'high': 15655.95, 'low': 15650.2, 'close': 15650.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797020, 'open': 15650.65, 'high': 15654.95, 'low': 15650.25, 'close': 15654.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797080, 'open': 15654.55, 'high': 15659.9, 'low': 15651.7, 'close': 15659.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797140, 'open': 15659.45, 'high': 15660.25, 'low': 15654.25, 'close': 15658.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797200, 'open': 15658.9, 'high': 15665.95, 'low': 15657.95, 'close': 15665.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797260, 'open': 15666.1, 'high': 15672.1, 'low': 15664.95, 'close': 15670.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797320, 'open': 15668.35, 'high': 15669.7, 'low': 15665.4, 'close': 15666.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797380, 'open': 15667.15, 'high': 15667.55, 'low': 15662.85, 'close': 15666.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797440, 'open': 15666.75, 'high': 15675.8, 'low': 15665.8, 'close': 15674.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797500, 'open': 15673.2, 'high': 15677.4, 'low': 15673.2, 'close': 15676.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797560, 'open': 15677.05, 'high': 15679.0, 'low': 15667.7, 'close': 15669.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797620, 'open': 15669.6, 'high': 15675.85, 'low': 15663.1, 'close': 15675.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797680, 'open': 15675.85, 'high': 15687.0, 'low': 15675.85, 'close': 15686.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797740, 'open': 15686.35, 'high': 15687.15, 'low': 15672.75, 'close': 15672.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797800, 'open': 15673.1, 'high': 15679.5, 'low': 15673.1, 'close': 15676.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797860, 'open': 15675.9, 'high': 15678.6, 'low': 15671.8, 'close': 15678.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797920, 'open': 15677.95, 'high': 15680.3, 'low': 15675.9, 'close': 15676.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655797980, 'open': 15676.6, 'high': 15679.65, 'low': 15675.5, 'close': 15679.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798040, 'open': 15680.15, 'high': 15683.4, 'low': 15676.75, 'close': 15680.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798100, 'open': 15680.55, 'high': 15681.85, 'low': 15678.15, 'close': 15678.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798160, 'open': 15678.1, 'high': 15678.6, 'low': 15672.2, 'close': 15673.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798220, 'open': 15675.4, 'high': 15683.2, 'low': 15675.05, 'close': 15681.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798280, 'open': 15681.5, 'high': 15681.5, 'low': 15674.9, 'close': 15679.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798340, 'open': 15678.5, 'high': 15678.55, 'low': 15674.75, 'close': 15678.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798400, 'open': 15677.85, 'high': 15693.5, 'low': 15677.85, 'close': 15691.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798460, 'open': 15691.2, 'high': 15691.2, 'low': 15681.6, 'close': 15682.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798520, 'open': 15681.75, 'high': 15682.9, 'low': 15673.7, 'close': 15675.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798580, 'open': 15675.05, 'high': 15678.3, 'low': 15670.05, 'close': 15670.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798640, 'open': 15669.7, 'high': 15675.0, 'low': 15663.75, 'close': 15675.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798700, 'open': 15674.85, 'high': 15677.45, 'low': 15673.6, 'close': 15674.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798760, 'open': 15673.95, 'high': 15673.95, 'low': 15664.55, 'close': 15664.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798820, 'open': 15664.25, 'high': 15667.0, 'low': 15659.4, 'close': 15667.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798880, 'open': 15666.9, 'high': 15677.3, 'low': 15666.9, 'close': 15677.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655798940, 'open': 15677.25, 'high': 15677.55, 'low': 15672.15, 'close': 15675.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799000, 'open': 15676.0, 'high': 15679.1, 'low': 15675.4, 'close': 15679.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799060, 'open': 15678.55, 'high': 15683.85, 'low': 15678.55, 'close': 15682.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799120, 'open': 15683.05, 'high': 15683.55, 'low': 15679.1, 'close': 15679.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799180, 'open': 15679.95, 'high': 15682.95, 'low': 15677.05, 'close': 15677.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799240, 'open': 15676.5, 'high': 15679.05, 'low': 15670.7, 'close': 15673.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799300, 'open': 15672.55, 'high': 15674.55, 'low': 15669.1, 'close': 15671.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799360, 'open': 15671.3, 'high': 15671.8, 'low': 15654.85, 'close': 15656.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799420, 'open': 15655.3, 'high': 15660.85, 'low': 15649.75, 'close': 15660.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799480, 'open': 15660.5, 'high': 15666.6, 'low': 15658.15, 'close': 15660.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799540, 'open': 15660.75, 'high': 15662.8, 'low': 15654.85, 'close': 15661.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799600, 'open': 15662.7, 'high': 15671.9, 'low': 15661.95, 'close': 15670.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799660, 'open': 15670.95, 'high': 15682.25, 'low': 15670.9, 'close': 15682.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799720, 'open': 15681.05, 'high': 15684.25, 'low': 15680.2, 'close': 15682.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799780, 'open': 15683.4, 'high': 15684.3, 'low': 15677.3, 'close': 15681.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799840, 'open': 15680.35, 'high': 15694.7, 'low': 15680.35, 'close': 15694.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799900, 'open': 15693.95, 'high': 15705.45, 'low': 15691.0, 'close': 15705.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655799960, 'open': 15706.45, 'high': 15707.25, 'low': 15691.15, 'close': 15691.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800020, 'open': 15692.5, 'high': 15705.2, 'low': 15691.55, 'close': 15705.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800080, 'open': 15705.0, 'high': 15705.75, 'low': 15699.85, 'close': 15703.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800140, 'open': 15702.55, 'high': 15703.7, 'low': 15692.55, 'close': 15692.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800200, 'open': 15692.4, 'high': 15703.35, 'low': 15692.4, 'close': 15701.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800260, 'open': 15700.35, 'high': 15705.65, 'low': 15695.3, 'close': 15695.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800320, 'open': 15696.05, 'high': 15696.05, 'low': 15689.7, 'close': 15695.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800380, 'open': 15694.9, 'high': 15695.7, 'low': 15689.75, 'close': 15694.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800440, 'open': 15693.65, 'high': 15697.1, 'low': 15690.7, 'close': 15697.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800500, 'open': 15697.35, 'high': 15697.65, 'low': 15687.15, 'close': 15688.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800560, 'open': 15687.6, 'high': 15693.4, 'low': 15685.25, 'close': 15693.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800620, 'open': 15691.95, 'high': 15698.9, 'low': 15685.35, 'close': 15685.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800680, 'open': 15685.9, 'high': 15690.1, 'low': 15684.2, 'close': 15686.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800740, 'open': 15685.85, 'high': 15687.9, 'low': 15680.7, 'close': 15684.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800800, 'open': 15683.25, 'high': 15684.0, 'low': 15677.8, 'close': 15681.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800860, 'open': 15681.8, 'high': 15683.95, 'low': 15677.6, 'close': 15683.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800920, 'open': 15683.5, 'high': 15683.5, 'low': 15676.15, 'close': 15676.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655800980, 'open': 15675.5, 'high': 15687.0, 'low': 15675.5, 'close': 15687.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801040, 'open': 15687.45, 'high': 15690.25, 'low': 15686.1, 'close': 15689.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801100, 'open': 15688.85, 'high': 15689.1, 'low': 15686.05, 'close': 15688.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801160, 'open': 15689.25, 'high': 15694.65, 'low': 15689.25, 'close': 15691.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801220, 'open': 15691.6, 'high': 15705.8, 'low': 15691.6, 'close': 15700.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801280, 'open': 15701.2, 'high': 15702.2, 'low': 15694.15, 'close': 15694.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801340, 'open': 15694.25, 'high': 15694.25, 'low': 15684.75, 'close': 15685.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801400, 'open': 15685.2, 'high': 15686.8, 'low': 15677.9, 'close': 15679.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801460, 'open': 15678.9, 'high': 15684.1, 'low': 15674.75, 'close': 15680.5, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801520, 'open': 15680.05, 'high': 15682.7, 'low': 15677.7, 'close': 15679.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801580, 'open': 15679.75, 'high': 15683.7, 'low': 15679.75, 'close': 15681.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801640, 'open': 15681.35, 'high': 15689.7, 'low': 15680.65, 'close': 15688.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801700, 'open': 15686.4, 'high': 15687.85, 'low': 15681.95, 'close': 15681.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801760, 'open': 15682.25, 'high': 15684.9, 'low': 15679.25, 'close': 15682.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801820, 'open': 15681.55, 'high': 15690.65, 'low': 15680.8, 'close': 15690.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801880, 'open': 15690.8, 'high': 15693.45, 'low': 15684.2, 'close': 15684.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655801940, 'open': 15684.6, 'high': 15689.6, 'low': 15683.35, 'close': 15688.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802000, 'open': 15686.0, 'high': 15692.85, 'low': 15684.65, 'close': 15692.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802060, 'open': 15693.1, 'high': 15703.0, 'low': 15690.35, 'close': 15702.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802120, 'open': 15701.95, 'high': 15702.1, 'low': 15691.45, 'close': 15693.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802180, 'open': 15693.65, 'high': 15699.5, 'low': 15693.05, 'close': 15698.6, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802240, 'open': 15698.3, 'high': 15703.35, 'low': 15694.7, 'close': 15703.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802300, 'open': 15703.75, 'high': 15703.75, 'low': 15698.7, 'close': 15699.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802360, 'open': 15699.95, 'high': 15702.0, 'low': 15694.75, 'close': 15696.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802420, 'open': 15696.15, 'high': 15696.15, 'low': 15690.2, 'close': 15692.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802480, 'open': 15693.7, 'high': 15694.5, 'low': 15687.85, 'close': 15688.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802540, 'open': 15689.3, 'high': 15695.75, 'low': 15685.75, 'close': 15695.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802600, 'open': 15696.85, 'high': 15698.7, 'low': 15692.75, 'close': 15693.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802660, 'open': 15693.45, 'high': 15694.4, 'low': 15685.35, 'close': 15685.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802720, 'open': 15686.3, 'high': 15686.3, 'low': 15681.0, 'close': 15685.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802780, 'open': 15685.1, 'high': 15685.1, 'low': 15672.55, 'close': 15672.9, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802840, 'open': 15672.15, 'high': 15672.15, 'low': 15647.25, 'close': 15651.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802900, 'open': 15650.4, 'high': 15650.4, 'low': 15638.0, 'close': 15646.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655802960, 'open': 15645.9, 'high': 15650.7, 'low': 15641.95, 'close': 15648.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803020, 'open': 15648.5, 'high': 15648.5, 'low': 15633.05, 'close': 15633.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803080, 'open': 15634.05, 'high': 15648.25, 'low': 15630.35, 'close': 15643.15, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803140, 'open': 15642.45, 'high': 15657.8, 'low': 15639.3, 'close': 15656.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803200, 'open': 15656.45, 'high': 15656.45, 'low': 15648.9, 'close': 15655.65, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803260, 'open': 15654.05, 'high': 15654.05, 'low': 15647.0, 'close': 15652.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803320, 'open': 15652.15, 'high': 15652.6, 'low': 15647.95, 'close': 15648.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803380, 'open': 15648.45, 'high': 15653.0, 'low': 15641.6, 'close': 15652.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803440, 'open': 15653.35, 'high': 15665.25, 'low': 15653.35, 'close': 15665.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803500, 'open': 15664.55, 'high': 15664.55, 'low': 15651.2, 'close': 15660.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803560, 'open': 15659.6, 'high': 15660.55, 'low': 15656.05, 'close': 15658.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803620, 'open': 15658.3, 'high': 15658.75, 'low': 15649.0, 'close': 15653.1, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803680, 'open': 15652.9, 'high': 15653.95, 'low': 15649.45, 'close': 15651.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803740, 'open': 15650.55, 'high': 15651.2, 'low': 15630.95, 'close': 15630.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803800, 'open': 15629.55, 'high': 15639.3, 'low': 15626.8, 'close': 15637.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803860, 'open': 15638.35, 'high': 15641.65, 'low': 15628.15, 'close': 15640.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803920, 'open': 15641.0, 'high': 15645.4, 'low': 15636.15, 'close': 15644.8, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655803980, 'open': 15644.3, 'high': 15644.85, 'low': 15628.15, 'close': 15636.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804040, 'open': 15636.4, 'high': 15636.95, 'low': 15621.95, 'close': 15622.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804100, 'open': 15621.65, 'high': 15632.65, 'low': 15619.95, 'close': 15632.25, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804160, 'open': 15633.7, 'high': 15642.3, 'low': 15626.6, 'close': 15639.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804220, 'open': 15638.75, 'high': 15641.8, 'low': 15636.35, 'close': 15639.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804280, 'open': 15638.75, 'high': 15642.05, 'low': 15634.55, 'close': 15640.55, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804340, 'open': 15640.25, 'high': 15647.0, 'low': 15637.1, 'close': 15647.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804400, 'open': 15646.6, 'high': 15647.15, 'low': 15636.65, 'close': 15640.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804460, 'open': 15640.5, 'high': 15645.05, 'low': 15634.65, 'close': 15639.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804520, 'open': 15640.05, 'high': 15640.45, 'low': 15634.95, 'close': 15640.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804580, 'open': 15640.2, 'high': 15641.5, 'low': 15634.75, 'close': 15635.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804640, 'open': 15635.2, 'high': 15638.55, 'low': 15633.65, 'close': 15637.7, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804700, 'open': 15637.45, 'high': 15638.0, 'low': 15630.55, 'close': 15638.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804760, 'open': 15637.7, 'high': 15641.6, 'low': 15633.3, 'close': 15641.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804820, 'open': 15641.5, 'high': 15646.2, 'low': 15641.5, 'close': 15645.85, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804880, 'open': 15646.4, 'high': 15653.05, 'low': 15644.65, 'close': 15649.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655804940, 'open': 15649.25, 'high': 15651.3, 'low': 15647.75, 'close': 15651.3, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805000, 'open': 15650.75, 'high': 15651.45, 'low': 15648.55, 'close': 15651.2, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805060, 'open': 15650.7, 'high': 15651.15, 'low': 15640.8, 'close': 15641.35, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805120, 'open': 15641.8, 'high': 15645.35, 'low': 15641.35, 'close': 15644.75, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805180, 'open': 15644.75, 'high': 15646.0, 'low': 15641.1, 'close': 15642.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805240, 'open': 15641.5, 'high': 15642.6, 'low': 15633.35, 'close': 15633.45, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805300, 'open': 15631.85, 'high': 15634.1, 'low': 15628.5, 'close': 15628.95, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805360, 'open': 15629.4, 'high': 15635.85, 'low': 15629.15, 'close': 15633.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805420, 'open': 15632.5, 'high': 15632.9, 'low': 15631.2, 'close': 15632.05, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805480, 'open': 15631.8, 'high': 15632.9, 'low': 15627.95, 'close': 15629.0, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805540, 'open': 15628.9, 'high': 15630.45, 'low': 15624.7, 'close': 15628.4, 'volume': 0, 'symbol': 'NIFTY'}, {'timestamp': 1655805600, 'open': 15629.0, 'high': 15634.15, 'low': 15626.35, 'close': 15634.15, 'volume': 0, 'symbol': 'NIFTY'}]

            #ivs = helper_utils.generate_random_ivs()
            """
            start = datetime.now()
            option_df = get_daily_option_data_2(symbol, day)
            end = datetime.now()
            print('option data fetch took', (end - start).total_seconds())
            """
            try:
                for i in range(len(price_list)):
                    price = price_list[i]
                    #iv = ivs[i]
                    #processor.process_input_data([price])
                    #processor.calculateMeasures()
                    ts = price['timestamp']
                    """
                    t_df = option_df[option_df['timestamp'] == ts][['instrument', 'oi', 'volume', 'open', 'high', 'low', 'close']]
                    t_df.set_index('instrument', inplace=True)
                    recs = t_df.to_dict('index')
                    """

                    recs = {'18400_PE': {'oi': 918400, 'volume': 15650, 'open': 337.55, 'high': 356.05, 'low': 333.95, 'close': 355.0}, '18400_CE': {'oi': 7561350, 'volume': 1651100, 'open': 1.5, 'high': 1.5, 'low': 1.05, 'close': 1.15}, '18300_PE': {'oi': 1651500, 'volume': 106700, 'open': 238.85, 'high': 256.6, 'low': 234.8, 'close': 254.65}, '18300_CE': {'oi': 8876250, 'volume': 2883200, 'open': 2.95, 'high': 3.6, 'low': 1.6, 'close': 1.75}, '18200_PE': {'oi': 2992350, 'volume': 710350, 'open': 125.05, 'high': 160.0, 'low': 125.05, 'close': 159.05}, '18200_CE': {'oi': 10904200, 'volume': 4354400, 'open': 8.9, 'high': 10.2, 'low': 4.8, 'close': 5.15}, '18100_CE': {'oi': 6178900, 'volume': 3805200, 'open': 29.0, 'high': 30.8, 'low': 22.3, 'close': 23.8}, '18100_PE': {'oi': 7415550, 'volume': 3030550, 'open': 57.5, 'high': 78.5, 'low': 57.5, 'close': 77.5}, '18000_PE': {'oi': 12389000, 'volume': 5424600, 'open': 25.0, 'high': 31.1, 'low': 22.9, 'close': 30.35}, '18000_CE': {'oi': 3336750, 'volume': 1150600, 'open': 100.0, 'high': 109.0, 'low': 75.35, 'close': 76.65}, '17900_CE': {'oi': 716050, 'volume': 163850, 'open': 172.45, 'high': 176.1, 'low': 156.45, 'close': 157.05}, '17900_PE': {'oi': 6893600, 'volume': 2551650, 'open': 10.3, 'high': 12.05, 'low': 8.3, 'close': 11.3}, '17800_PE': {'oi': 7972350, 'volume': 1939700, 'open': 4.5, 'high': 4.9, 'low': 3.4, 'close': 4.75}, '17800_CE': {'oi': 1025150, 'volume': 52900, 'open': 268.3, 'high': 271.75, 'low': 250.4, 'close': 251.05}, '17700_CE': {'oi': 260650, 'volume': 1900, 'open': 352.3, 'high': 366.25, 'low': 348.6, 'close': 348.6}, '17700_PE': {'oi': 5400950, 'volume': 1306050, 'open': 3.05, 'high': 3.05, 'low': 1.85, 'close': 2.15}, '17600_CE': {'oi': 62800, 'volume': 2300, 'open': 460.0, 'high': 466.0, 'low': 446.2, 'close': 447.15}, '17600_PE': {'oi': 4284600, 'volume': 499950, 'open': 1.45, 'high': 1.7, 'low': 1.15, 'close': 1.45}, '17500_PE': {'oi': 9329750, 'volume': 1264450, 'open': 1.2, 'high': 1.45, 'low': 1.1, 'close': 1.15}, '17500_CE': {'oi': 446500, 'volume': 1700, 'open': 558.25, 'high': 564.15, 'low': 546.6, 'close': 546.6}}

                    pm.option_price_input({'timestamp': ts, 'symbol': symbol, 'records': recs})
                    pm.price_input(price)
                    story_book.option_minute_data_stream({'timestamp': ts, 'symbol': symbol, 'records': recs})
                    #story_book.spot_minute_data_stream(price, iv)
                    story_book.spot_minute_data_stream(price)
                    time.sleep(0.005)

                for strategy_tuple, trade_details in pm.position_book.items():
                    #print(strategy)
                    position = trade_details['position']
                    strategy_id = strategy_tuple[1]
                    symbol = strategy_tuple[0]
                    trade_id = strategy_tuple[2]
                    strategy_signal_generator = story_book.get_signal_generator_from_id(strategy_id)
                    for leg_id, leg_info in position.items():
                        _tmp = {'day': day, 'symbol': symbol, 'strategy': strategy_id, 'trade_id': trade_id, 'leg': leg_id, 'side': leg_info['side'], 'entry_time': leg_info['entry_time'], 'exit_time': leg_info['exit_time'], 'entry_price': leg_info['entry_price'], 'exit_price': leg_info['exit_price'] , 'realized_pnl': round(leg_info['realized_pnl'], 2), 'un_realized_pnl': round(leg_info['un_realized_pnl'], 2)}
                        _tmp['week_day'] = datetime.strptime(day, '%Y-%m-%d').strftime('%A') if type(day) == str else day.strftime('%A')
                        trigger_details = strategy_signal_generator.tradable_signals[trade_id].legs[leg_id]
                        _tmp = {**_tmp, **trigger_details}
                        signal_custom_details = strategy_signal_generator.tradable_signals[trade_id].custom_features
                        signal_params = ['pattern_height']
                        for signal_param in signal_params:
                            if signal_param in signal_custom_details:
                                _tmp[signal_param] = signal_custom_details[signal_param]
                        if story_book.record_metric:
                            params = strategy_signal_generator.params_repo.get((trade_id, leg_id), {})
                            #print('params====', params)
                            _tmp = {**_tmp, **params}
                        results.append(_tmp)
            except Exception as e:

                print('error on', day)
                print(e)
                print(traceback.format_exc())
            # print(results)

        end_time = datetime.now()
        print((end_time - start_time).total_seconds())
        # print(results)
        return results


    def run(self):
        if not self.strat_config['symbols']:
            self.strat_config["symbols"] = default_symbols
        final_result = []
        for symbol in self.strat_config['symbols']:
            if len(self.strat_config['test_days']) == 0:
                all_days = get_all_days(helper_utils.get_nse_index_symbol(symbol))
                to_date = datetime.strptime(self.strat_config['to_date'], '%Y-%m-%d') if type(self.strat_config['to_date']) == str else self.strat_config['to_date']
                end_date = max(x for x in all_days if x <= to_date.date())
                end_date_index = all_days.index(end_date)
                for_past_days = int(self.strat_config['for_past_days']) if type(self.strat_config['for_past_days']) == str else self.strat_config['for_past_days']
                start_date_index = min(end_date_index + for_past_days, len(all_days))
                days = all_days[end_date_index:start_date_index]
                days = [x for x in days if (datetime.strptime(x, '%Y-%m-%d').strftime('%A') if type(x) == str else x.strftime('%A')) in self.strat_config['week_days']] if self.strat_config['week_days'] else days
                print(days)
                self.strat_config['test_days'] = days
            result = self.back_test(symbol)
            final_result.extend(result)
        return final_result

def print_lines_of_code():
    from os import listdir
    from os.path import isfile, isdir, join

    def item_line_count(path):
        if isdir(path):
            return dir_line_count(path)
        elif isfile(path):
            return len(open(path, 'rb').readlines())
        else:
            return 0


    def dir_line_count(dir):
        return sum(map(lambda item: item_line_count(join(dir, item)), listdir(dir)))

    ln = item_line_count('./')
    print(ln)

if __name__ == '__main__':
    argv = sys.argv[1:]
    print(argv)
    kwargs = {kw[0]: kw[1] for kw in [ar.split('=') for ar in argv if ar.find('=') > 0]}
    args = [arg for arg in argv if arg.find('=') < 0]
    if 'strat_config' in kwargs:
        strat_config_file = kwargs['strat_config']
    elif args:
        strat_config_file = args[0]
    else:
        strat_config_file = 'bkp_cheap_option.json'
    strat_config_path = str(Path(__file__).resolve().parent) + "/scenarios/" + strat_config_file

    with open(strat_config_path) as bt_config:
        strat_config = json.load(bt_config)

    back_tester = StartegyBackTester(strat_config)
    results = back_tester.run()
    results = pd.DataFrame(results)
    part_results = results  # [['day',	'symbol',	'strategy',	'signal_id',	'trigger',	'entry_time',	'exit_time',	'entry_price',	'exit_price',	'realized_pnl',	'un_realized_pnl',	'week_day',	'seq',	'target',	'stop_loss',	'duration',	'quantity',	'exit_type', 'neck_point',	'pattern_height',	'pattern_time', 'pattern_price', 'pattern_location']]
    print('total P&L', part_results['realized_pnl'].sum())
    part_results['entry_time_read'] = part_results['entry_time'].apply(lambda x: datetime.fromtimestamp(x))
    part_results['exit_time_read'] = part_results['exit_time'].apply(lambda x: datetime.fromtimestamp(x) if not math.isnan(x) else x)
    search_days = results['day'].to_list()
    file_name = strat_config_file.split('.')[0]
    file_path = reports_dir + file_name + '.csv'

    print('saving result to file', file_path)
    part_results.to_csv(file_path, index=False)
